<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVS Asistencia</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .hidden { display: none !important; }
        
        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #3B82F6 0%, #EC4899 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .login-box {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .login-title { font-size: 1.875rem; font-weight: bold; color: #4B5563; text-align: center; margin-bottom: 0.5rem; }
        .login-subtitle { font-size: 0.875rem; color: #6B7280; text-align: center; margin-bottom: 2rem; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            background: #F3F4F6;
            padding: 0.25rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .tab {
            flex: 1;
            padding: 0.5rem 0.25rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: #6B7280;
        }
        .tab.active {
            background: white;
            color: #3B82F6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Form */
        .form-group { margin-bottom: 1.5rem; }
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #4B5563;
            margin-bottom: 0.5rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        .btn {
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: white;
        }
        .btn-primary { background: linear-gradient(135deg, #3B82F6 0%, #EC4899 100%); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .info-box {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #F3F4F6;
            border-radius: 0.5rem;
            text-align: center;
        }
        .info-text { font-size: 0.75rem; color: #6B7280; }
        
        /* Employee View */
        .employee-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #3B82F6 0%, #EC4899 100%);
            padding: 1rem;
        }
        .container { max-width: 28rem; margin: 0 auto; }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .btn-small {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            color: white;
        }
        .btn-logout { background: #EF4444; }
        .btn-password { background: #3B82F6; margin-right: 0.5rem; }
        
        .select-obra {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #D1D5DB;
            border-radius: 0.75rem;
            font-size: 1rem;
            margin-top: 0.75rem;
        }
        
        .btn-marca {
            width: 100%;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: white;
            margin-bottom: 0.75rem;
        }
        .btn-entrada { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .btn-colacion { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .btn-salida { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1 class="login-title">CVS Asistencia</h1>
            <p class="login-subtitle">Electric Mobility Services</p>
            
            <div class="tabs">
                <button class="tab active" onclick="cambiarTipoLogin('empleado')">üë∑ Empleado</button>
                <button class="tab" onclick="cambiarTipoLogin('admin')">üëî Admin</button>
                <button class="tab" onclick="cambiarTipoLogin('fiscalizador')">üõ°Ô∏è DT</button>
            </div>
            
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label" id="labelIdentificador">RUT</label>
                    <input type="text" id="inputIdentificador" class="form-input" placeholder="12.345.678-9" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" id="inputPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <button type="submit" class="btn btn-primary" id="btnLogin">Iniciar Sesi√≥n</button>
            </form>
            
            <div class="info-box">
                <p class="info-text">CVS ELECTRIC MOBILITY SERVICES SPA<br>RUT: 78.324.019-K</p>
            </div>
            
            <div class="info-box" style="margin-top: 1rem; background: #DBEAFE; border: 1px solid #93C5FD;">
                <p class="info-text" style="color: #1E40AF;">
                    ‚ÑπÔ∏è Contrase√±a por defecto: <strong>cvs2026</strong><br>
                    <span id="infoCredenciales"></span>
                </p>
            </div>
        </div>
    </div>
    
    <!-- PANTALLA EMPLEADO -->
    <div id="employeeScreen" class="employee-screen hidden">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <div>
                        <h1 style="font-size: 1.5rem; font-weight: bold; color: #4B5563;">CVS Asistencia</h1>
                        <p style="font-size: 0.75rem; color: #6B7280;">Electric Mobility Services</p>
                    </div>
                    <div>
                        <button class="btn-small btn-password" onclick="mostrarCambioPassword()">üîê</button>
                        <button class="btn-small btn-logout" onclick="cerrarSesion()">Salir</button>
                    </div>
                </div>
                
                <div style="background: rgba(59, 130, 246, 0.1); border-radius: 0.5rem; padding: 1rem;">
                    <p style="font-size: 0.875rem; color: #6B7280; margin: 0 0 0.25rem 0;">Empleado</p>
                    <p style="font-weight: 600; color: #1F2937; margin: 0 0 0.25rem 0;" id="empNombre"></p>
                    <p style="font-size: 0.875rem; color: #6B7280; margin: 0 0 0.25rem 0;" id="empRut"></p>
                    <p style="font-size: 0.75rem; color: #9CA3AF; margin: 0;" id="empCargo"></p>
                </div>
            </div>
            
            <div class="card">
                <h3 style="font-weight: 600; margin-bottom: 0.75rem;">üìç Seleccione Obra/Faena:</h3>
                <select id="selectObra" class="select-obra">
                    <option value="">‚ö†Ô∏è Seleccione una obra/faena...</option>
                </select>
            </div>
            
            <div class="card">
                <button class="btn-marca btn-entrada" onclick="marcarAsistencia('ENTRADA')">‚úì MARCAR ENTRADA</button>
                <button class="btn-marca btn-colacion" onclick="marcarAsistencia('INICIO COLACI√ìN')">‚è∞ INICIO COLACI√ìN</button>
                <button class="btn-marca btn-colacion" onclick="marcarAsistencia('FIN COLACI√ìN')">‚è∞ FIN COLACI√ìN</button>
                <button class="btn-marca btn-salida" onclick="marcarAsistencia('SALIDA')">‚úì MARCAR SALIDA</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL CAMBIAR CONTRASE√ëA -->
    <div id="modalPassword" class="modal hidden">
        <div class="modal-content">
            <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem;">üîê Cambiar Contrase√±a</h2>
            
            <div class="form-group">
                <label class="form-label">Contrase√±a Actual</label>
                <input type="password" id="passActual" class="form-input" placeholder="Contrase√±a actual">
            </div>
            
            <div class="form-group">
                <label class="form-label">Nueva Contrase√±a</label>
                <input type="password" id="passNueva" class="form-input" placeholder="M√≠nimo 6 caracteres">
            </div>
            
            <div class="form-group">
                <label class="form-label">Confirmar Nueva</label>
                <input type="password" id="passConfirmar" class="form-input" placeholder="Repita la nueva contrase√±a">
            </div>
            
            <div style="display: flex; gap: 0.75rem;">
                <button class="btn" style="background: #6B7280;" onclick="cerrarModalPassword()">Cancelar</button>
                <button class="btn btn-primary" onclick="cambiarPassword()">Cambiar</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN
        const SUPABASE_URL = 'https://yhgiitkblzhpkjjrzmoz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InloZ2lpdGtibHpocGtqanJ6bW96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1OTk1MzIsImV4cCI6MjA4NTE3NTUzMn0.6did5rBQ0nLu2qMQ6S7wTwzMU8F-a6AtZj_EUnm3tO0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let tipoLogin = 'empleado';
        let currentUser = null;
        let obras = [];
        
        // INICIALIZAR
        window.addEventListener('DOMContentLoaded', () => {
            cargarObras();
        });
        
        // CAMBIAR TIPO DE LOGIN
        function cambiarTipoLogin(tipo) {
            tipoLogin = tipo;
            
            // Actualizar tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Cambiar labels
            const label = document.getElementById('labelIdentificador');
            const input = document.getElementById('inputIdentificador');
            const info = document.getElementById('infoCredenciales');
            
            if (tipo === 'empleado') {
                label.textContent = 'RUT';
                input.placeholder = '12.345.678-9';
                info.textContent = '';
            } else if (tipo === 'admin') {
                label.textContent = 'Email';
                input.placeholder = 'admin@cvs.cl';
                info.textContent = 'Email: admin@cvs.cl';
            } else {
                label.textContent = 'Email';
                input.placeholder = 'fiscalizador@dt.gob.cl';
                info.textContent = 'Email: fiscalizador@dt.gob.cl';
            }
        }
        
        // LOGIN
        async function handleLogin(e) {
            e.preventDefault();
            
            const identificador = document.getElementById('inputIdentificador').value;
            const password = document.getElementById('inputPassword').value;
            const btnLogin = document.getElementById('btnLogin');
            
            btnLogin.disabled = true;
            btnLogin.textContent = 'Ingresando...';
            
            try {
                if (tipoLogin === 'empleado') {
                    const { data, error } = await supabase
                        .from('empleados')
                        .select('*')
                        .eq('rut', identificador)
                        .eq('activo', true)
                        .single();
                    
                    if (error || !data) {
                        alert('‚ùå RUT no encontrado');
                        return;
                    }
                    
                    if (password !== 'cvs2026') {
                        alert('‚ùå Contrase√±a incorrecta');
                        return;
                    }
                    
                    currentUser = data;
                    mostrarVistaEmpleado();
                    
                } else {
                    alert('Vista admin/fiscalizador en desarrollo');
                }
                
            } catch (error) {
                console.error(error);
                alert('Error al iniciar sesi√≥n');
            } finally {
                btnLogin.disabled = false;
                btnLogin.textContent = 'Iniciar Sesi√≥n';
            }
        }
        
        // CARGAR OBRAS
        async function cargarObras() {
            try {
                const { data, error } = await supabase
                    .from('obras_faenas')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre');
                
                if (!error && data) {
                    obras = data;
                    const select = document.getElementById('selectObra');
                    data.forEach(obra => {
                        const option = document.createElement('option');
                        option.value = obra.id;
                        option.textContent = obra.nombre;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando obras:', error);
            }
        }
        
        // MOSTRAR VISTA EMPLEADO
        function mostrarVistaEmpleado() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('employeeScreen').classList.remove('hidden');
            
            document.getElementById('empNombre').textContent = currentUser.nombre_completo;
            document.getElementById('empRut').textContent = currentUser.rut;
            document.getElementById('empCargo').textContent = currentUser.cargo;
        }
        
        // MARCAR ASISTENCIA
        async function marcarAsistencia(tipoEvento) {
            const obraId = document.getElementById('selectObra').value;
            
            if (!obraId) {
                alert('‚ö†Ô∏è Debe seleccionar una obra/faena');
                return;
            }
            
            const obra = obras.find(o => o.id === obraId);
            
            if (!navigator.geolocation) {
                alert('‚ùå Tu navegador no soporta GPS');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        const { data, error } = await supabase
                            .from('marcaciones')
                            .insert([{
                                id_empleado: currentUser.id,
                                nombre_empleado: currentUser.nombre_completo,
                                email_empleado: currentUser.email_personal,
                                rut_empleado: currentUser.rut,
                                tipo_evento: tipoEvento,
                                id_obra_faena: obra.id,
                                nombre_obra_faena: obra.nombre,
                                latitud: position.coords.latitude,
                                longitud: position.coords.longitude,
                                precision_gps: position.coords.accuracy,
                                id_dispositivo: 'DEV-' + Date.now(),
                                sincronizado: true,
                                hash_verificacion: 'HASH-' + Date.now()
                            }]);
                        
                        if (error) throw error;
                        
                        alert(`‚úÖ Marcaci√≥n registrada: ${tipoEvento}\n\nüìç Obra: ${obra.nombre}\nüïê ${new Date().toLocaleTimeString('es-CL')}`);
                        
                        setTimeout(() => {
                            cerrarSesion();
                        }, 2000);
                        
                    } catch (error) {
                        console.error(error);
                        alert('‚ùå Error al marcar asistencia');
                    }
                },
                (error) => {
                    alert('‚ùå No se pudo obtener la ubicaci√≥n GPS. Verifique los permisos.');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }
        
        // CAMBIAR CONTRASE√ëA
        function mostrarCambioPassword() {
            document.getElementById('modalPassword').classList.remove('hidden');
        }
        
        function cerrarModalPassword() {
            document.getElementById('modalPassword').classList.add('hidden');
            document.getElementById('passActual').value = '';
            document.getElementById('passNueva').value = '';
            document.getElementById('passConfirmar').value = '';
        }
        
        async function cambiarPassword() {
            const actual = document.getElementById('passActual').value;
            const nueva = document.getElementById('passNueva').value;
            const confirmar = document.getElementById('passConfirmar').value;
            
            if (!actual || !nueva || !confirmar) {
                alert('‚ö†Ô∏è Complete todos los campos');
                return;
            }
            
            if (actual !== 'cvs2026') {
                alert('‚ùå Contrase√±a actual incorrecta');
                return;
            }
            
            if (nueva.length < 6) {
                alert('‚ö†Ô∏è M√≠nimo 6 caracteres');
                return;
            }
            
            if (nueva !== confirmar) {
                alert('‚ùå Las contrase√±as no coinciden');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('empleados')
                    .update({ password_hash: nueva })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                alert('‚úÖ Contrase√±a cambiada exitosamente\n\nUse su nueva contrase√±a para volver a ingresar.');
                cerrarSesion();
                
            } catch (error) {
                console.error(error);
                alert('‚ùå Error al cambiar contrase√±a');
            }
        }
        
        // CERRAR SESI√ìN
        function cerrarSesion() {
            currentUser = null;
            document.getElementById('employeeScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('inputIdentificador').value = '';
            document.getElementById('inputPassword').value = '';
            document.getElementById('selectObra').value = '';
        }
    </script>
</body>
</html>
