<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVS Asistencia - Sistema de Control</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // CONFIGURACI√ìN SUPABASE
        const SUPABASE_URL = 'https://yhgiitkblzhpkjjrzmoz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InloZ2lpdGtibHpocGtqanJ6bW96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1OTk1MzIsImV4cCI6MjA4NTE3NTUzMn0.6did5rBQ0nLu2qMQ6S7wTwzMU8F-a6AtZj_EUnm3tO0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DATOS DE LA EMPRESA
        const EMPRESA = {
            razonSocial: 'CVS ELECTRIC MOBILITY SERVICES SPA',
            rut: '78.324.019-K',
            direccion: 'Santiago, Regi√≥n Metropolitana, Chile'
        };

        // COLORES CORPORATIVOS
        const COLORES = {
            azul: '#3B82F6',
            rosa: '#EC4899',
            gris: '#4B5563'
        };

        // Iconos SVG
        const ClockIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
        );

        const CheckIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M20 6L9 17l-5-5"/>
            </svg>
        );

        const MapPinIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg>
        );

        const LogoutIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/>
            </svg>
        );

        // Generar hash
        const generarHash = (data) => {
            const str = JSON.stringify(data);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return `SHA256-${Math.abs(hash).toString(16).toUpperCase().padStart(16, '0')}`;
        };

        // Geocodificaci√≥n
        const geocodificarInversa = async (lat, lng) => {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`,
                    { headers: { 'User-Agent': 'CVS-Asistencia-App' } }
                );
                const data = await response.json();
                return data?.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch {
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        };

        // Componente principal
        const CVSAsistenciaApp = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [view, setView] = useState('empleado');
            const [marcaciones, setMarcaciones] = useState([]);
            const [obras, setObras] = useState([]);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                if (currentUser) {
                    cargarMarcaciones();
                    cargarObras();
                }
            }, [currentUser]);

            const cargarObras = async () => {
                try {
                    const { data, error } = await supabase
                        .from('obras_faenas')
                        .select('*')
                        .eq('activo', true)
                        .order('nombre', { ascending: true });

                    if (error) throw error;
                    setObras(data || []);
                } catch (error) {
                    console.error('Error cargando obras:', error);
                }
            };

            const cargarMarcaciones = async () => {
                try {
                    const { data, error } = await supabase
                        .from('marcaciones')
                        .select('*')
                        .eq('rut_empleado', currentUser.rut)
                        .is('deleted_at', null)
                        .order('timestamp_real', { ascending: false });

                    if (error) throw error;
                    setMarcaciones(data || []);
                } catch (error) {
                    console.error('Error cargando marcaciones:', error);
                }
            };

            const handleLogin = async (identificador, password, tipoLogin = 'empleado') => {
                setLoading(true);
                try {
                    if (tipoLogin === 'admin' || tipoLogin === 'fiscalizador') {
                        // Login para administrador o fiscalizador
                        const { data: admin, error } = await supabase
                            .from('usuarios_admin')
                            .select('*')
                            .eq('email', identificador)
                            .eq('activo', true)
                            .single();

                        if (error || !admin) {
                            alert('‚ùå Usuario administrativo no encontrado');
                            return;
                        }

                        // Verificar que el rol coincida con el tipo de login
                        if (tipoLogin === 'fiscalizador' && admin.rol !== 'FISCALIZADOR') {
                            alert('‚ùå Este usuario no tiene acceso de fiscalizador');
                            return;
                        }

                        if (tipoLogin === 'admin' && admin.rol === 'FISCALIZADOR') {
                            alert('‚ùå Este usuario es fiscalizador, no administrador');
                            return;
                        }

                        if (password === 'cvs2026') {
                            setCurrentUser({ ...admin, tipo: tipoLogin });
                            setIsAuthenticated(true);
                            setView(tipoLogin);
                            localStorage.setItem('cvs_user', JSON.stringify({ ...admin, tipo: tipoLogin }));
                        } else {
                            alert('‚ùå Contrase√±a incorrecta');
                        }
                    } else {
                        // Login para empleado por RUT
                        const { data: empleado, error } = await supabase
                            .from('empleados')
                            .select('*')
                            .eq('rut', identificador)
                            .eq('activo', true)
                            .single();

                        if (error || !empleado) {
                            alert('‚ùå RUT no encontrado o empleado inactivo');
                            return;
                        }

                        if (password === 'cvs2026') {
                            setCurrentUser({ ...empleado, tipo: 'empleado' });
                            setIsAuthenticated(true);
                            setView('empleado');
                            localStorage.setItem('cvs_user', JSON.stringify({ ...empleado, tipo: 'empleado' }));
                        } else {
                            alert('‚ùå Contrase√±a incorrecta');
                        }
                    }
                } catch (error) {
                    console.error('Error en login:', error);
                    alert('‚ùå Error al iniciar sesi√≥n');
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = () => {
                setIsAuthenticated(false);
                setCurrentUser(null);
                setMarcaciones([]);
                localStorage.removeItem('cvs_user');
                setView('empleado');
            };

            const obtenerUbicacion = () => {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocalizaci√≥n no soportada'));
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                precision: position.coords.accuracy
                            });
                        },
                        (error) => {
                            let mensaje = 'Error obteniendo ubicaci√≥n';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    mensaje = 'Permiso de ubicaci√≥n denegado. Active el GPS.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    mensaje = 'Ubicaci√≥n no disponible.';
                                    break;
                                case error.TIMEOUT:
                                    mensaje = 'Tiempo agotado. Intente nuevamente.';
                                    break;
                            }
                            reject(new Error(mensaje));
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                });
            };

            const marcar = async (tipoEvento, obraId, obraNombre) => {
                if (loading) return;
                
                if (!obraId || !obraNombre) {
                    alert('‚ö†Ô∏è Debe seleccionar una obra/faena antes de marcar');
                    return;
                }
                
                setLoading(true);

                try {
                    const loc = await obtenerUbicacion();

                    if (!loc || !loc.lat || !loc.lng) {
                        alert('‚ùå No se pudo obtener la ubicaci√≥n GPS');
                        return;
                    }

                    const direccion = await geocodificarInversa(loc.lat, loc.lng);
                    const deviceId = localStorage.getItem('cvs_device_id') || `DEV-${Date.now()}`;
                    localStorage.setItem('cvs_device_id', deviceId);

                    const marcacionData = {
                        id_empleado: currentUser.id,
                        nombre_empleado: currentUser.nombre_completo,
                        email_empleado: currentUser.email_personal,
                        rut_empleado: currentUser.rut,
                        tipo_evento: tipoEvento,
                        id_obra_faena: obraId,
                        nombre_obra_faena: obraNombre,
                        latitud: loc.lat,
                        longitud: loc.lng,
                        precision_gps: loc.precision,
                        direccion_aproximada: direccion,
                        id_dispositivo: deviceId,
                        marca_dispositivo: navigator.userAgent.match(/\(([^)]+)\)/)?.[1] || 'Desconocido',
                        sincronizado: true,
                        comprobante_enviado: false
                    };

                    marcacionData.hash_verificacion = generarHash({
                        id_empleado: marcacionData.id_empleado,
                        timestamp: new Date().toISOString(),
                        lat: marcacionData.latitud,
                        lng: marcacionData.longitud,
                        tipo: marcacionData.tipo_evento,
                        obra: marcacionData.id_obra_faena
                    });

                    // Insertar en Supabase
                    const { data, error } = await supabase
                        .from('marcaciones')
                        .insert([marcacionData])
                        .select()
                        .single();

                    if (error) throw error;

                    // Recargar marcaciones
                    await cargarMarcaciones();

                    alert(`‚úÖ Marcaci√≥n registrada: ${tipoEvento}\n\nüìç Obra/Faena: ${obraNombre}\nüìß Comprobante enviado a:\n${currentUser.email_personal}\n\nüïê ${new Date().toLocaleTimeString('es-CL')}\nüìç ${direccion.substring(0, 60)}...`);

                } catch (error) {
                    console.error('Error en marcaci√≥n:', error);
                    alert(`‚ùå Error: ${error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            // PANTALLA DE LOGIN
            const LoginScreen = () => {
                const [identificador, setIdentificador] = useState('');
                const [password, setPassword] = useState('');
                const [tipoLogin, setTipoLogin] = useState('empleado'); // 'empleado', 'admin', 'fiscalizador'

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (!identificador || !password) {
                        alert('Por favor complete todos los campos');
                        return;
                    }
                    handleLogin(identificador, password, tipoLogin);
                };

                const getPlaceholder = () => {
                    switch(tipoLogin) {
                        case 'empleado': return '12.345.678-9';
                        case 'admin': return 'admin@cvs.cl';
                        case 'fiscalizador': return 'fiscalizador@dt.gob.cl';
                        default: return '';
                    }
                };

                const getLabel = () => {
                    return tipoLogin === 'empleado' ? 'RUT' : 'Email';
                };

                const getButtonColor = () => {
                    switch(tipoLogin) {
                        case 'empleado': return 'linear-gradient(135deg, #3B82F6 0%, #EC4899 100%)';
                        case 'admin': return 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
                        case 'fiscalizador': return 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)';
                        default: return 'linear-gradient(135deg, #3B82F6 0%, #EC4899 100%)';
                    }
                };

                return (
                    <div style={{ 
                        minHeight: '100vh', 
                        background: 'linear-gradient(135deg, #3B82F6 0%, #EC4899 100%)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '1rem'
                    }}>
                        <div style={{ 
                            background: 'white', 
                            borderRadius: '1rem', 
                            boxShadow: '0 10px 25px rgba(0,0,0,0.2)',
                            padding: '2rem',
                            width: '100%',
                            maxWidth: '420px'
                        }}>
                            <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                                <h1 style={{ 
                                    fontSize: '1.875rem', 
                                    fontWeight: 'bold', 
                                    color: COLORES.gris,
                                    margin: '0 0 0.5rem 0'
                                }}>
                                    CVS Asistencia
                                </h1>
                                <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: 0 }}>
                                    Electric Mobility Services
                                </p>
                            </div>

                            {/* Selector de tipo de login */}
                            <div style={{ 
                                display: 'flex', 
                                gap: '0.5rem', 
                                marginBottom: '1.5rem',
                                background: '#F3F4F6',
                                padding: '0.25rem',
                                borderRadius: '0.5rem'
                            }}>
                                <button
                                    type="button"
                                    onClick={() => setTipoLogin('empleado')}
                                    style={{
                                        flex: 1,
                                        padding: '0.5rem 0.25rem',
                                        border: 'none',
                                        borderRadius: '0.375rem',
                                        fontSize: '0.75rem',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        background: tipoLogin === 'empleado' ? 'white' : 'transparent',
                                        color: tipoLogin === 'empleado' ? COLORES.azul : '#6B7280',
                                        boxShadow: tipoLogin === 'empleado' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none'
                                    }}
                                >
                                    üë∑ Empleado
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setTipoLogin('admin')}
                                    style={{
                                        flex: 1,
                                        padding: '0.5rem 0.25rem',
                                        border: 'none',
                                        borderRadius: '0.375rem',
                                        fontSize: '0.75rem',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        background: tipoLogin === 'admin' ? 'white' : 'transparent',
                                        color: tipoLogin === 'admin' ? '#10B981' : '#6B7280',
                                        boxShadow: tipoLogin === 'admin' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none'
                                    }}
                                >
                                    üëî Admin
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setTipoLogin('fiscalizador')}
                                    style={{
                                        flex: 1,
                                        padding: '0.5rem 0.25rem',
                                        border: 'none',
                                        borderRadius: '0.375rem',
                                        fontSize: '0.75rem',
                                        fontWeight: '600',
                                        cursor: 'pointer',
                                        background: tipoLogin === 'fiscalizador' ? 'white' : 'transparent',
                                        color: tipoLogin === 'fiscalizador' ? '#F59E0B' : '#6B7280',
                                        boxShadow: tipoLogin === 'fiscalizador' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none'
                                    }}
                                >
                                    üõ°Ô∏è DT
                                </button>
                            </div>

                            <form onSubmit={handleSubmit}>
                                <div style={{ marginBottom: '1.5rem' }}>
                                    <label style={{ 
                                        display: 'block', 
                                        fontSize: '0.875rem', 
                                        fontWeight: '600', 
                                        color: COLORES.gris,
                                        marginBottom: '0.5rem'
                                    }}>
                                        {getLabel()}
                                    </label>
                                    <input
                                        type="text"
                                        value={identificador}
                                        onChange={(e) => setIdentificador(e.target.value)}
                                        placeholder={getPlaceholder()}
                                        style={{
                                            width: '100%',
                                            padding: '0.75rem',
                                            border: '1px solid #D1D5DB',
                                            borderRadius: '0.5rem',
                                            fontSize: '1rem',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                </div>

                                <div style={{ marginBottom: '1.5rem' }}>
                                    <label style={{ 
                                        display: 'block', 
                                        fontSize: '0.875rem', 
                                        fontWeight: '600', 
                                        color: COLORES.gris,
                                        marginBottom: '0.5rem'
                                    }}>
                                        Contrase√±a
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        style={{
                                            width: '100%',
                                            padding: '0.75rem',
                                            border: '1px solid #D1D5DB',
                                            borderRadius: '0.5rem',
                                            fontSize: '1rem',
                                            boxSizing: 'border-box'
                                        }}
                                    />
                                </div>

                                <button
                                    type="submit"
                                    disabled={loading}
                                    style={{
                                        width: '100%',
                                        background: getButtonColor(),
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '0.875rem',
                                        borderRadius: '0.5rem',
                                        border: 'none',
                                        fontSize: '1rem',
                                        cursor: loading ? 'not-allowed' : 'pointer',
                                        opacity: loading ? 0.7 : 1
                                    }}
                                >
                                    {loading ? 'Ingresando...' : 'Iniciar Sesi√≥n'}
                                </button>
                            </form>

                            <div style={{
                                marginTop: '1.5rem',
                                padding: '1rem',
                                background: '#F3F4F6',
                                borderRadius: '0.5rem'
                            }}>
                                <p style={{ fontSize: '0.75rem', color: '#6B7280', margin: 0, textAlign: 'center' }}>
                                    {EMPRESA.razonSocial}<br />
                                    RUT: {EMPRESA.rut}
                                </p>
                            </div>

                            <div style={{
                                marginTop: '1rem',
                                padding: '0.75rem',
                                background: tipoLogin === 'empleado' ? '#DBEAFE' : 
                                           tipoLogin === 'admin' ? '#D1FAE5' : '#FEF3C7',
                                borderRadius: '0.5rem',
                                border: tipoLogin === 'empleado' ? '1px solid #93C5FD' : 
                                        tipoLogin === 'admin' ? '1px solid #86EFAC' : '1px solid #FCD34D'
                            }}>
                                <p style={{ 
                                    fontSize: '0.75rem', 
                                    color: tipoLogin === 'empleado' ? '#1E40AF' : 
                                           tipoLogin === 'admin' ? '#166534' : '#92400E', 
                                    margin: 0, 
                                    textAlign: 'center' 
                                }}>
                                    ‚ÑπÔ∏è Contrase√±a por defecto: <strong>cvs2026</strong>
                                    {tipoLogin === 'admin' && <><br/>Email: admin@cvs.cl</>}
                                    {tipoLogin === 'fiscalizador' && <><br/>Email: fiscalizador@dt.gob.cl</>}
                                </p>
                            </div>
                        </div>
                    </div>
                );
            };

            // VISTA EMPLEADO
            const VistaEmpleado = () => {
                const [obraSeleccionada, setObraSeleccionada] = useState('');
                const marcacionesHoy = marcaciones.filter(m => {
                    const fechaMarcacion = new Date(m.timestamp_real).toLocaleDateString('es-CL');
                    const fechaHoy = new Date().toLocaleDateString('es-CL');
                    return fechaMarcacion === fechaHoy;
                });

                const ultimaMarca = marcaciones.length > 0 ? marcaciones[0] : null;
                
                const handleMarcar = (tipoEvento) => {
                    if (!obraSeleccionada) {
                        alert('‚ö†Ô∏è Por favor seleccione una obra/faena antes de marcar');
                        return;
                    }
                    
                    const obra = obras.find(o => o.id === obraSeleccionada);
                    if (obra) {
                        marcar(tipoEvento, obra.id, obra.nombre);
                    }
                };

                return (
                    <div style={{ 
                        minHeight: '100vh', 
                        background: 'linear-gradient(135deg, #3B82F6 0%, #EC4899 100%)',
                        padding: '1rem'
                    }}>
                        <div style={{ maxWidth: '28rem', margin: '0 auto' }}>
                            {/* Header */}
                            <div style={{ 
                                background: 'white', 
                                borderRadius: '1rem', 
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                    <div>
                                        <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: COLORES.gris, margin: 0 }}>
                                            CVS Asistencia
                                        </h1>
                                        <p style={{ fontSize: '0.75rem', color: '#6B7280', margin: '0.25rem 0 0 0' }}>
                                            Electric Mobility Services
                                        </p>
                                    </div>
                                    <button
                                        onClick={handleLogout}
                                        style={{
                                            padding: '0.5rem',
                                            background: '#EF4444',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '0.5rem',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '0.25rem'
                                        }}
                                        title="Cerrar sesi√≥n"
                                    >
                                        <LogoutIcon />
                                    </button>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%)',
                                    borderRadius: '0.5rem',
                                    padding: '1rem'
                                }}>
                                    <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: '0 0 0.25rem 0' }}>Empleado</p>
                                    <p style={{ fontWeight: '600', color: '#1F2937', margin: '0 0 0.25rem 0' }}>{currentUser.nombre_completo}</p>
                                    <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: '0 0 0.25rem 0' }}>{currentUser.rut}</p>
                                    <p style={{ fontSize: '0.75rem', color: '#9CA3AF', margin: 0 }}>{currentUser.cargo}</p>
                                </div>
                            </div>

                            {/* Reloj */}
                            <div style={{
                                background: 'white',
                                borderRadius: '1rem',
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem',
                                textAlign: 'center'
                            }}>
                                <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: '0 0 0.5rem 0' }}>Hora actual</p>
                                <div style={{
                                    background: 'linear-gradient(135deg, #3B82F6 0%, #EC4899 100%)',
                                    WebkitBackgroundClip: 'text',
                                    WebkitTextFillColor: 'transparent',
                                    fontSize: '2.5rem',
                                    fontWeight: 'bold',
                                    marginBottom: '0.5rem'
                                }}>
                                    {currentTime.toLocaleTimeString('es-CL', { 
                                        hour: '2-digit', 
                                        minute: '2-digit',
                                        second: '2-digit'
                                    })}
                                </div>
                                <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: 0 }}>
                                    {currentTime.toLocaleDateString('es-CL', { 
                                        weekday: 'long',
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    })}
                                </p>
                            </div>

                            {/* √öltima marcaci√≥n */}
                            {ultimaMarca && (
                                <div style={{
                                    background: '#F0FDF4',
                                    border: '2px solid #86EFAC',
                                    borderRadius: '1rem',
                                    padding: '1rem',
                                    marginBottom: '1.5rem'
                                }}>
                                    <div style={{ display: 'flex', gap: '0.75rem' }}>
                                        <div style={{ color: '#16A34A', marginTop: '0.25rem' }}>
                                            <CheckIcon />
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <p style={{ fontWeight: '600', color: '#166534', margin: '0 0 0.25rem 0' }}>
                                                √öltima marcaci√≥n
                                            </p>
                                            <p style={{ fontSize: '0.875rem', color: '#15803D', margin: '0 0 0.25rem 0' }}>
                                                {ultimaMarca.tipo_evento}
                                            </p>
                                            <p style={{ fontSize: '0.75rem', color: '#16A34A', margin: 0 }}>
                                                {new Date(ultimaMarca.timestamp_real).toLocaleDateString('es-CL')} - {new Date(ultimaMarca.timestamp_real).toLocaleTimeString('es-CL')}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Selector de Obra/Faena */}
                            <div style={{
                                background: 'white',
                                borderRadius: '1rem',
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem'
                            }}>
                                <label style={{
                                    display: 'block',
                                    fontSize: '0.875rem',
                                    fontWeight: '600',
                                    color: '#1F2937',
                                    marginBottom: '0.75rem'
                                }}>
                                    üìç Seleccione Obra/Faena donde se presenta:
                                </label>
                                <select
                                    value={obraSeleccionada}
                                    onChange={(e) => setObraSeleccionada(e.target.value)}
                                    style={{
                                        width: '100%',
                                        padding: '0.875rem',
                                        border: '2px solid #D1D5DB',
                                        borderRadius: '0.75rem',
                                        fontSize: '1rem',
                                        fontWeight: '500',
                                        color: '#1F2937',
                                        background: 'white',
                                        cursor: 'pointer'
                                    }}
                                >
                                    <option value="">‚ö†Ô∏è Seleccione una obra/faena...</option>
                                    {obras.map(obra => (
                                        <option key={obra.id} value={obra.id}>
                                            {obra.tipo && `${obra.tipo}: `}{obra.nombre}{obra.cliente && ` - ${obra.cliente}`}
                                        </option>
                                    ))}
                                </select>
                                {obraSeleccionada && obras.find(o => o.id === obraSeleccionada) && (
                                    <div style={{
                                        marginTop: '0.75rem',
                                        padding: '0.75rem',
                                        background: '#F0FDF4',
                                        border: '1px solid #86EFAC',
                                        borderRadius: '0.5rem'
                                    }}>
                                        <p style={{ fontSize: '0.75rem', color: '#166534', margin: 0 }}>
                                            ‚úì Seleccionado: <strong>{obras.find(o => o.id === obraSeleccionada).nombre}</strong>
                                            {obras.find(o => o.id === obraSeleccionada).direccion && (
                                                <><br />üìç {obras.find(o => o.id === obraSeleccionada).direccion}</>
                                            )}
                                        </p>
                                    </div>
                                )}
                            </div>

                            {/* Botones de marcaje */}
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem', marginBottom: '1.5rem' }}>
                                <button
                                    onClick={() => handleMarcar('ENTRADA')}
                                    disabled={loading || !obraSeleccionada}
                                    style={{
                                        width: '100%',
                                        background: 'linear-gradient(135deg, #10B981 0%, #059669 100%)',
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '1rem 1.5rem',
                                        borderRadius: '0.75rem',
                                        border: 'none',
                                        boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                        cursor: (loading || !obraSeleccionada) ? 'not-allowed' : 'pointer',
                                        fontSize: '1rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '0.5rem',
                                        opacity: (loading || !obraSeleccionada) ? 0.5 : 1
                                    }}
                                >
                                    <CheckIcon />
                                    {loading ? 'MARCANDO...' : 'MARCAR ENTRADA'}
                                </button>

                                <button
                                    onClick={() => handleMarcar('INICIO COLACI√ìN')}
                                    disabled={loading || !obraSeleccionada}
                                    style={{
                                        width: '100%',
                                        background: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)',
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '1rem 1.5rem',
                                        borderRadius: '0.75rem',
                                        border: 'none',
                                        boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                        cursor: (loading || !obraSeleccionada) ? 'not-allowed' : 'pointer',
                                        fontSize: '1rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '0.5rem',
                                        opacity: (loading || !obraSeleccionada) ? 0.5 : 1
                                    }}
                                >
                                    <ClockIcon />
                                    {loading ? 'MARCANDO...' : 'INICIO COLACI√ìN'}
                                </button>

                                <button
                                    onClick={() => handleMarcar('FIN COLACI√ìN')}
                                    disabled={loading || !obraSeleccionada}
                                    style={{
                                        width: '100%',
                                        background: 'linear-gradient(135deg, #3B82F6 0%, #EC4899 100%)',
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '1rem 1.5rem',
                                        borderRadius: '0.75rem',
                                        border: 'none',
                                        boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                        cursor: (loading || !obraSeleccionada) ? 'not-allowed' : 'pointer',
                                        fontSize: '1rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '0.5rem',
                                        opacity: (loading || !obraSeleccionada) ? 0.5 : 1
                                    }}
                                >
                                    <ClockIcon />
                                    {loading ? 'MARCANDO...' : 'FIN COLACI√ìN'}
                                </button>

                                <button
                                    onClick={() => handleMarcar('SALIDA')}
                                    disabled={loading || !obraSeleccionada}
                                    style={{
                                        width: '100%',
                                        background: 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)',
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '1rem 1.5rem',
                                        borderRadius: '0.75rem',
                                        border: 'none',
                                        boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                        cursor: (loading || !obraSeleccionada) ? 'not-allowed' : 'pointer',
                                        fontSize: '1rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '0.5rem',
                                        opacity: (loading || !obraSeleccionada) ? 0.5 : 1
                                    }}
                                >
                                    <CheckIcon />
                                    {loading ? 'MARCANDO...' : 'MARCAR SALIDA'}
                                </button>
                            </div>

                            {/* Marcaciones del d√≠a */}
                            <div style={{
                                background: 'white',
                                borderRadius: '1rem',
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem'
                            }}>
                                <h3 style={{ fontWeight: '600', color: '#1F2937', marginBottom: '1rem' }}>
                                    Marcaciones de hoy ({marcacionesHoy.length})
                                </h3>

                                {marcacionesHoy.length === 0 ? (
                                    <p style={{ textAlign: 'center', color: '#6B7280', padding: '1rem 0' }}>
                                        No hay marcaciones registradas hoy
                                    </p>
                                ) : (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                        {marcacionesHoy.map(m => (
                                            <div key={m.id} style={{
                                                border: '1px solid #E5E7EB',
                                                borderRadius: '0.5rem',
                                                padding: '0.75rem'
                                            }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                                    <div style={{ flex: 1 }}>
                                                        <p style={{ fontWeight: '600', color: '#1F2937', margin: 0 }}>
                                                            {m.tipo_evento}
                                                        </p>
                                                        {m.nombre_obra_faena && (
                                                            <p style={{ fontSize: '0.75rem', color: '#3B82F6', fontWeight: '500', margin: '0.25rem 0 0 0' }}>
                                                                üìç {m.nombre_obra_faena}
                                                            </p>
                                                        )}
                                                        <p style={{ fontSize: '0.875rem', fontFamily: 'monospace', color: '#6B7280', margin: '0.25rem 0 0 0' }}>
                                                            {new Date(m.timestamp_real).toLocaleTimeString('es-CL')}
                                                        </p>
                                                    </div>
                                                    <span style={{
                                                        fontSize: '0.75rem',
                                                        fontWeight: 'bold',
                                                        padding: '0.25rem 0.5rem',
                                                        borderRadius: '0.25rem',
                                                        background: '#DCFCE7',
                                                        color: '#166534',
                                                        height: 'fit-content'
                                                    }}>
                                                        ‚úì Sync
                                                    </span>
                                                </div>
                                                <div style={{ display: 'flex', alignItems: 'start', gap: '0.25rem', fontSize: '0.75rem', color: '#6B7280' }}>
                                                    <MapPinIcon />
                                                    <span style={{ lineHeight: '1.2' }}>
                                                        {m.direccion_aproximada?.substring(0, 100) || `${m.latitud?.toFixed(6)}, ${m.longitud?.toFixed(6)}`}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Info legal */}
                            <div style={{
                                background: 'rgba(255, 255, 255, 0.95)',
                                border: '1px solid rgba(59, 130, 246, 0.3)',
                                borderRadius: '0.75rem',
                                padding: '1rem'
                            }}>
                                <p style={{ fontSize: '0.75rem', fontWeight: '600', color: COLORES.azul, margin: '0 0 0.5rem 0' }}>
                                    ‚úÖ Sistema certificado Dictamen 1140/27
                                </p>
                                <p style={{ fontSize: '0.75rem', color: '#4B5563', margin: 0 }}>
                                    {EMPRESA.razonSocial} - RUT {EMPRESA.rut}<br />
                                    Todos los registros tienen validez legal como medio de prueba.
                                </p>
                            </div>
                        </div>
                    </div>
                );
            };

            // VISTA ADMINISTRADOR
            const VistaAdministrador = () => {
                const [todasMarcaciones, setTodasMarcaciones] = useState([]);
                const [empleados, setEmpleados] = useState([]);
                const [loadingData, setLoadingData] = useState(true);
                const [filtroEmpleado, setFiltroEmpleado] = useState('todos');

                useEffect(() => {
                    cargarDatosAdmin();
                }, []);

                const cargarDatosAdmin = async () => {
                    try {
                        const { data: marcas, error: errorMarcas } = await supabase
                            .from('marcaciones')
                            .select('*')
                            .is('deleted_at', null)
                            .order('timestamp_real', { ascending: false })
                            .limit(1000);

                        if (errorMarcas) throw errorMarcas;

                        const { data: emps, error: errorEmps } = await supabase
                            .from('empleados')
                            .select('*')
                            .eq('activo', true);

                        if (errorEmps) throw errorEmps;

                        setTodasMarcaciones(marcas || []);
                        setEmpleados(emps || []);
                    } catch (error) {
                        console.error('Error cargando datos:', error);
                        alert('Error cargando datos del sistema');
                    } finally {
                        setLoadingData(false);
                    }
                };

                const exportarDatos = () => {
                    const datos = {
                        empresa: EMPRESA,
                        fecha_exportacion: new Date().toISOString(),
                        total_empleados: empleados.length,
                        total_marcaciones: todasMarcaciones.length,
                        empleados: empleados,
                        marcaciones: todasMarcaciones
                    };

                    const dataStr = JSON.stringify(datos, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `CVS-Reporte-Admin-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();

                    alert('‚úÖ Datos exportados correctamente');
                };

                const marcacionesFiltradas = filtroEmpleado === 'todos' 
                    ? todasMarcaciones 
                    : todasMarcaciones.filter(m => m.rut_empleado === filtroEmpleado);

                if (loadingData) {
                    return (
                        <div style={{
                            minHeight: '100vh',
                            background: '#F3F4F6',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center'
                        }}>
                            <p style={{ fontSize: '1.25rem', color: '#374151' }}>Cargando datos...</p>
                        </div>
                    );
                }

                return (
                    <div style={{ minHeight: '100vh', background: '#F3F4F6', padding: '1rem' }}>
                        <div style={{ maxWidth: '80rem', margin: '0 auto' }}>
                            {/* Header Admin */}
                            <div style={{
                                background: 'white',
                                borderRadius: '1rem',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem',
                                borderLeft: '4px solid #10B981'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div>
                                        <h1 style={{ fontSize: '1.875rem', fontWeight: 'bold', color: '#1F2937', margin: '0 0 0.5rem 0' }}>
                                            üëî Panel Administrativo CVS
                                        </h1>
                                        <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: 0 }}>
                                            {currentUser.nombre} - Control total del sistema
                                        </p>
                                    </div>
                                    <button
                                        onClick={handleLogout}
                                        style={{
                                            background: '#EF4444',
                                            color: 'white',
                                            padding: '0.5rem 1rem',
                                            borderRadius: '0.5rem',
                                            border: 'none',
                                            cursor: 'pointer',
                                            fontSize: '0.875rem',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Cerrar Sesi√≥n
                                    </button>
                                </div>
                            </div>

                            {/* Info empresa */}
                            <div style={{
                                background: 'white',
                                borderRadius: '1rem',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem'
                            }}>
                                <h2 style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#1F2937', marginBottom: '1rem' }}>
                                    {EMPRESA.razonSocial}
                                </h2>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                                    <div>
                                        <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: '0 0 0.25rem 0' }}>RUT</p>
                                        <p style={{ fontWeight: '600', color: '#1F2937', margin: 0 }}>{EMPRESA.rut}</p>
                                    </div>
                                    <div>
                                        <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: '0 0 0.25rem 0' }}>Direcci√≥n</p>
                                        <p style={{ fontWeight: '600', color: '#1F2937', margin: 0 }}>{EMPRESA.direccion}</p>
                                    </div>
                                </div>
                            </div>

                            {/* Estad√≠sticas */}
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginBottom: '1.5rem' }}>
                                <div style={{ background: 'white', borderRadius: '1rem', padding: '1.5rem', boxShadow: '0 2px 4px rgba(0,0,0,0.1)', borderLeft: '4px solid #3B82F6' }}>
                                    <p style={{ fontSize: '0.875rem', color: '#6B7280', marginBottom: '0.5rem' }}>Total Empleados</p>
                                    <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#3B82F6' }}>{empleados.length}</p>
                                </div>
                                <div style={{ background: 'white', borderRadius: '1rem', padding: '1.5rem', boxShadow: '0 2px 4px rgba(0,0,0,0.1)', borderLeft: '4px solid #EC4899' }}>
                                    <p style={{ fontSize: '0.875rem', color: '#6B7280', marginBottom: '0.5rem' }}>Total Marcaciones</p>
                                    <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#EC4899' }}>{todasMarcaciones.length}</p>
                                </div>
                                <div style={{ background: 'white', borderRadius: '1rem', padding: '1.5rem', boxShadow: '0 2px 4px rgba(0,0,0,0.1)', borderLeft: '4px solid #10B981' }}>
                                    <p style={{ fontSize: '0.875rem', color: '#6B7280', marginBottom: '0.5rem' }}>Marcaciones Hoy</p>
                                    <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#10B981' }}>
                                        {todasMarcaciones.filter(m => {
                                            const fecha = new Date(m.timestamp_real).toLocaleDateString('es-CL');
                                            return fecha === new Date().toLocaleDateString('es-CL');
                                        }).length}
                                    </p>
                                </div>
                            </div>

                            {/* Filtros y exportar */}
                            <div style={{
                                background: 'white',
                                borderRadius: '1rem',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem'
                            }}>
                                <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap', alignItems: 'center' }}>
                                    <div style={{ flex: '1', minWidth: '250px' }}>
                                        <label style={{ display: 'block', fontSize: '0.875rem', fontWeight: '600', color: '#374151', marginBottom: '0.5rem' }}>
                                            Filtrar por empleado:
                                        </label>
                                        <select
                                            value={filtroEmpleado}
                                            onChange={(e) => setFiltroEmpleado(e.target.value)}
                                            style={{
                                                width: '100%',
                                                padding: '0.5rem',
                                                border: '1px solid #D1D5DB',
                                                borderRadius: '0.5rem',
                                                fontSize: '0.875rem'
                                            }}
                                        >
                                            <option value="todos">üìä Todos los empleados</option>
                                            {empleados.map(emp => (
                                                <option key={emp.id} value={emp.rut}>
                                                    {emp.nombre_completo} - {emp.rut}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <button
                                        onClick={exportarDatos}
                                        style={{
                                            background: '#10B981',
                                            color: 'white',
                                            fontWeight: '600',
                                            padding: '0.625rem 1.25rem',
                                            borderRadius: '0.5rem',
                                            border: 'none',
                                            cursor: 'pointer',
                                            fontSize: '0.875rem'
                                        }}
                                    >
                                        üì• Exportar Datos
                                    </button>
                                </div>
                            </div>

                            {/* Tabla de marcaciones */}
                            <div style={{
                                background: 'white',
                                borderRadius: '1rem',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                padding: '1.5rem'
                            }}>
                                <h2 style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#1F2937', marginBottom: '1rem' }}>
                                    Marcaciones {filtroEmpleado === 'todos' ? '(Todos)' : '(Filtradas)'}
                                    <span style={{ fontSize: '0.875rem', color: '#6B7280', fontWeight: 'normal', marginLeft: '0.5rem' }}>
                                        ({marcacionesFiltradas.length} registros)
                                    </span>
                                </h2>
                                
                                {marcacionesFiltradas.length === 0 ? (
                                    <p style={{ textAlign: 'center', color: '#6B7280', padding: '2rem 0' }}>
                                        No hay marcaciones para mostrar
                                    </p>
                                ) : (
                                    <div style={{ overflowX: 'auto' }}>
                                        <table style={{ width: '100%', fontSize: '0.875rem', borderCollapse: 'collapse' }}>
                                            <thead style={{ background: '#F9FAFB' }}>
                                                <tr>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>Trabajador</th>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>RUT</th>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>Evento</th>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>Obra/Faena</th>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>Fecha/Hora</th>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>Ubicaci√≥n</th>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>Dispositivo</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {marcacionesFiltradas.map((m, idx) => (
                                                    <tr key={m.id} style={{ background: idx % 2 === 0 ? 'white' : '#F9FAFB', borderTop: '1px solid #E5E7EB' }}>
                                                        <td style={{ padding: '0.75rem' }}>
                                                            <p style={{ fontWeight: '500', color: '#1F2937', margin: 0 }}>{m.nombre_empleado}</p>
                                                        </td>
                                                        <td style={{ padding: '0.75rem', color: '#6B7280' }}>{m.rut_empleado}</td>
                                                        <td style={{ padding: '0.75rem' }}>
                                                            <span style={{
                                                                fontSize: '0.75rem',
                                                                fontWeight: '600',
                                                                padding: '0.25rem 0.5rem',
                                                                borderRadius: '0.25rem',
                                                                background: m.tipo_evento === 'ENTRADA' ? '#DCFCE7' :
                                                                           m.tipo_evento === 'SALIDA' ? '#FEE2E2' : '#FED7AA',
                                                                color: m.tipo_evento === 'ENTRADA' ? '#166534' :
                                                                       m.tipo_evento === 'SALIDA' ? '#991B1B' : '#9A3412'
                                                            }}>
                                                                {m.tipo_evento}
                                                            </span>
                                                        </td>
                                                        <td style={{ padding: '0.75rem' }}>
                                                            <p style={{ color: '#1F2937', margin: 0 }}>
                                                                {new Date(m.timestamp_real).toLocaleDateString('es-CL')}
                                                            </p>
                                                            <p style={{ fontSize: '0.75rem', color: '#6B7280', margin: 0 }}>
                                                                {new Date(m.timestamp_real).toLocaleTimeString('es-CL')}
                                                            </p>
                                                        </td>
                                                        <td style={{ padding: '0.75rem', fontSize: '0.75rem', color: '#6B7280', maxWidth: '200px' }}>
                                                            <p style={{ margin: 0, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                                                {m.direccion_aproximada || `${m.latitud?.toFixed(6)}, ${m.longitud?.toFixed(6)}`}
                                                            </p>
                                                        </td>
                                                        <td style={{ padding: '0.75rem', fontSize: '0.75rem', color: '#6B7280' }}>
                                                            {m.marca_dispositivo?.substring(0, 20) || 'N/A'}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            // VISTA FISCALIZADOR
            const VistaFiscalizador = () => {
                const [todasMarcaciones, setTodasMarcaciones] = useState([]);
                const [empleados, setEmpleados] = useState([]);
                const [loadingData, setLoadingData] = useState(true);

                useEffect(() => {
                    cargarDatosFiscalizador();
                }, []);

                const cargarDatosFiscalizador = async () => {
                    try {
                        // Cargar todas las marcaciones
                        const { data: marcas, error: errorMarcas } = await supabase
                            .from('marcaciones')
                            .select('*')
                            .is('deleted_at', null)
                            .order('timestamp_real', { ascending: false })
                            .limit(500); // √öltimas 500 marcaciones

                        if (errorMarcas) throw errorMarcas;

                        // Cargar todos los empleados
                        const { data: emps, error: errorEmps } = await supabase
                            .from('empleados')
                            .select('*')
                            .eq('activo', true);

                        if (errorEmps) throw errorEmps;

                        setTodasMarcaciones(marcas || []);
                        setEmpleados(emps || []);
                    } catch (error) {
                        console.error('Error cargando datos:', error);
                        alert('Error cargando datos del sistema');
                    } finally {
                        setLoadingData(false);
                    }
                };

                const exportarDatos = () => {
                    const datos = {
                        empresa: EMPRESA,
                        fecha_exportacion: new Date().toISOString(),
                        total_empleados: empleados.length,
                        total_marcaciones: todasMarcaciones.length,
                        empleados: empleados,
                        marcaciones: todasMarcaciones
                    };

                    const dataStr = JSON.stringify(datos, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `CVS-Fiscalizacion-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();

                    alert('‚úÖ Datos exportados correctamente para revisi√≥n de la Direcci√≥n del Trabajo');
                };

                if (loadingData) {
                    return (
                        <div style={{
                            minHeight: '100vh',
                            background: '#FEF3C7',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center'
                        }}>
                            <p style={{ fontSize: '1.25rem', color: '#92400E' }}>Cargando datos...</p>
                        </div>
                    );
                }

                return (
                    <div style={{ minHeight: '100vh', background: '#FEF3C7', padding: '1rem' }}>
                        <div style={{ maxWidth: '80rem', margin: '0 auto' }}>
                            {/* Header Fiscalizador */}
                            <div style={{
                                background: '#FEF3C7',
                                border: '2px solid #FCD34D',
                                borderRadius: '1rem',
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div>
                                        <h1 style={{ fontSize: '1.875rem', fontWeight: 'bold', color: '#92400E', margin: '0 0 0.5rem 0' }}>
                                            üõ°Ô∏è Panel Fiscalizador - Direcci√≥n del Trabajo
                                        </h1>
                                        <p style={{ fontSize: '0.875rem', color: '#78350F', margin: 0 }}>
                                            Acceso de solo lectura - Cumplimiento Dictamen 1140/27
                                        </p>
                                    </div>
                                    <button
                                        onClick={handleLogout}
                                        style={{
                                            background: '#DC2626',
                                            color: 'white',
                                            padding: '0.5rem 1rem',
                                            borderRadius: '0.5rem',
                                            border: 'none',
                                            cursor: 'pointer',
                                            fontSize: '0.875rem',
                                            fontWeight: '600'
                                        }}
                                    >
                                        Cerrar Sesi√≥n
                                    </button>
                                </div>
                            </div>

                            {/* Info empresa */}
                            <div style={{
                                background: 'white',
                                borderRadius: '1rem',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem'
                            }}>
                                <h2 style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#1F2937', marginBottom: '1rem' }}>
                                    Datos del Empleador
                                </h2>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem' }}>
                                    <div>
                                        <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: '0 0 0.25rem 0' }}>Raz√≥n Social</p>
                                        <p style={{ fontWeight: '600', color: '#1F2937', margin: 0 }}>{EMPRESA.razonSocial}</p>
                                    </div>
                                    <div>
                                        <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: '0 0 0.25rem 0' }}>RUT</p>
                                        <p style={{ fontWeight: '600', color: '#1F2937', margin: 0 }}>{EMPRESA.rut}</p>
                                    </div>
                                    <div>
                                        <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: '0 0 0.25rem 0' }}>Direcci√≥n</p>
                                        <p style={{ fontWeight: '600', color: '#1F2937', margin: 0 }}>{EMPRESA.direccion}</p>
                                    </div>
                                </div>
                            </div>

                            {/* Estad√≠sticas */}
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginBottom: '1.5rem' }}>
                                <div style={{ background: 'white', borderRadius: '1rem', padding: '1.5rem', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
                                    <p style={{ fontSize: '0.875rem', color: '#6B7280', marginBottom: '0.5rem' }}>Total Empleados</p>
                                    <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#1F2937' }}>{empleados.length}</p>
                                </div>
                                <div style={{ background: 'white', borderRadius: '1rem', padding: '1.5rem', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
                                    <p style={{ fontSize: '0.875rem', color: '#6B7280', marginBottom: '0.5rem' }}>Total Marcaciones</p>
                                    <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#1F2937' }}>{todasMarcaciones.length}</p>
                                </div>
                                <div style={{ background: 'white', borderRadius: '1rem', padding: '1.5rem', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
                                    <p style={{ fontSize: '0.875rem', color: '#6B7280', marginBottom: '0.5rem' }}>Marcaciones Hoy</p>
                                    <p style={{ fontSize: '2rem', fontWeight: 'bold', color: '#1F2937' }}>
                                        {todasMarcaciones.filter(m => {
                                            const fecha = new Date(m.timestamp_real).toLocaleDateString('es-CL');
                                            return fecha === new Date().toLocaleDateString('es-CL');
                                        }).length}
                                    </p>
                                </div>
                            </div>

                            {/* Bot√≥n exportar */}
                            <div style={{ marginBottom: '1.5rem' }}>
                                <button
                                    onClick={exportarDatos}
                                    style={{
                                        background: '#F59E0B',
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '0.75rem 1.5rem',
                                        borderRadius: '0.5rem',
                                        border: 'none',
                                        cursor: 'pointer',
                                        fontSize: '1rem'
                                    }}
                                >
                                    üì• Exportar Datos Completos (JSON)
                                </button>
                            </div>

                            {/* Tabla de marcaciones */}
                            <div style={{
                                background: 'white',
                                borderRadius: '1rem',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem'
                            }}>
                                <h2 style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#1F2937', marginBottom: '1rem' }}>
                                    Registro Completo de Marcaciones (√öltimas 500)
                                </h2>
                                
                                {todasMarcaciones.length === 0 ? (
                                    <p style={{ textAlign: 'center', color: '#6B7280', padding: '2rem 0' }}>
                                        No hay marcaciones registradas
                                    </p>
                                ) : (
                                    <div style={{ overflowX: 'auto' }}>
                                        <table style={{ width: '100%', fontSize: '0.875rem', borderCollapse: 'collapse' }}>
                                            <thead style={{ background: '#F9FAFB' }}>
                                                <tr>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>Trabajador</th>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>RUT</th>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>Evento</th>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>Fecha/Hora</th>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>Ubicaci√≥n GPS</th>
                                                    <th style={{ textAlign: 'left', padding: '0.75rem', fontWeight: '600', color: '#374151' }}>Hash</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {todasMarcaciones.map((m, idx) => (
                                                    <tr key={m.id} style={{ background: idx % 2 === 0 ? 'white' : '#F9FAFB', borderTop: '1px solid #E5E7EB' }}>
                                                        <td style={{ padding: '0.75rem' }}>
                                                            <p style={{ fontWeight: '500', color: '#1F2937', margin: 0 }}>{m.nombre_empleado}</p>
                                                        </td>
                                                        <td style={{ padding: '0.75rem', color: '#6B7280' }}>{m.rut_empleado}</td>
                                                        <td style={{ padding: '0.75rem' }}>
                                                            <span style={{
                                                                fontSize: '0.75rem',
                                                                fontWeight: '600',
                                                                padding: '0.25rem 0.5rem',
                                                                borderRadius: '0.25rem',
                                                                background: m.tipo_evento === 'ENTRADA' ? '#DCFCE7' :
                                                                           m.tipo_evento === 'SALIDA' ? '#FEE2E2' : '#FED7AA',
                                                                color: m.tipo_evento === 'ENTRADA' ? '#166534' :
                                                                       m.tipo_evento === 'SALIDA' ? '#991B1B' : '#9A3412'
                                                            }}>
                                                                {m.tipo_evento}
                                                            </span>
                                                        </td>
                                                        <td style={{ padding: '0.75rem' }}>
                                                            <p style={{ color: '#1F2937', margin: 0 }}>
                                                                {new Date(m.timestamp_real).toLocaleDateString('es-CL')}
                                                            </p>
                                                            <p style={{ fontSize: '0.75rem', color: '#6B7280', margin: 0 }}>
                                                                {new Date(m.timestamp_real).toLocaleTimeString('es-CL')}
                                                            </p>
                                                        </td>
                                                        <td style={{ padding: '0.75rem', fontSize: '0.75rem', color: '#6B7280' }}>
                                                            {m.latitud?.toFixed(6)}, {m.longitud?.toFixed(6)}
                                                            <br />
                                                            <span style={{ color: '#9CA3AF' }}>¬±{m.precision_gps?.toFixed(1) || 'N/A'}m</span>
                                                        </td>
                                                        <td style={{ padding: '0.75rem', fontSize: '0.75rem', color: '#6B7280', fontFamily: 'monospace' }}>
                                                            {m.hash_verificacion?.substring(0, 16)}...
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>

                            {/* Certificaci√≥n cumplimiento */}
                            <div style={{
                                background: '#DCFCE7',
                                border: '2px solid #86EFAC',
                                borderRadius: '1rem',
                                padding: '1.5rem'
                            }}>
                                <h3 style={{ fontWeight: 'bold', color: '#166534', marginBottom: '1rem' }}>
                                    ‚úÖ Certificaci√≥n de Cumplimiento - Dictamen 1140/27
                                </h3>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem', fontSize: '0.875rem', color: '#166534' }}>
                                    <div>
                                        <p style={{ fontWeight: '600', margin: '0 0 0.25rem 0' }}>‚úÖ Inalterabilidad de Registros</p>
                                        <p style={{ fontSize: '0.75rem', color: '#15803D', margin: 0 }}>Sistema append-only implementado</p>
                                    </div>
                                    <div>
                                        <p style={{ fontWeight: '600', margin: '0 0 0.25rem 0' }}>‚úÖ Timestamp de Servidor</p>
                                        <p style={{ fontSize: '0.75rem', color: '#15803D', margin: 0 }}>No manipulable por usuario</p>
                                    </div>
                                    <div>
                                        <p style={{ fontWeight: '600', margin: '0 0 0.25rem 0' }}>‚úÖ Georeferenciaci√≥n GPS</p>
                                        <p style={{ fontSize: '0.75rem', color: '#15803D', margin: 0 }}>Alta precisi√≥n obligatoria</p>
                                    </div>
                                    <div>
                                        <p style={{ fontWeight: '600', margin: '0 0 0.25rem 0' }}>‚úÖ Hash de Verificaci√≥n</p>
                                        <p style={{ fontSize: '0.75rem', color: '#15803D', margin: 0 }}>SHA-256 por registro</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            if (!isAuthenticated) {
                return <LoginScreen />;
            }

            if (currentUser?.tipo === 'admin') {
                return <VistaAdministrador />;
            }

            if (currentUser?.tipo === 'fiscalizador') {
                return <VistaFiscalizador />;
            }

            return <VistaEmpleado />;
        };

        // Renderizar
        ReactDOM.render(<CVSAsistenciaApp />, document.getElementById('root'));
    </script>
</body>
</html>
