<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVS Asistencia</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #3B82F6 0%, #EC4899 100%); min-height: 100vh; }
        .container { max-width: 400px; margin: 2rem auto; padding: 2rem; background: white; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        h1 { text-align: center; color: #4B5563; margin: 0 0 0.5rem 0; font-size: 1.875rem; }
        .subtitle { text-align: center; color: #6B7280; font-size: 0.875rem; margin: 0 0 2rem 0; }
        .tabs { display: flex; gap: 0.5rem; background: #F3F4F6; padding: 0.25rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .tab { flex: 1; padding: 0.5rem; border: none; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; cursor: pointer; background: transparent; color: #6B7280; }
        .tab.active { background: white; color: #3B82F6; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        label { display: block; font-size: 0.875rem; font-weight: 600; color: #4B5563; margin-bottom: 0.5rem; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.5rem; font-size: 1rem; margin-bottom: 1rem; }
        button { width: 100%; padding: 0.875rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; color: white; }
        .btn-login { background: linear-gradient(135deg, #3B82F6 0%, #EC4899 100%); }
        .btn-marca { background: linear-gradient(135deg, #10B981 0%, #059669 100%); margin-bottom: 0.75rem; }
        .btn-historial { background: linear-gradient(135deg, #3B82F6 0%, #EC4899 100%); margin-bottom: 0.75rem; }
        .btn-logout { background: #EF4444; }
        .info { padding: 0.75rem; background: #DBEAFE; border-radius: 0.5rem; margin-top: 1rem; text-align: center; font-size: 0.75rem; color: #1E40AF; }
        .hidden { display: none !important; }
        .employee-info { background: rgba(59, 130, 246, 0.1); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; }
        .employee-info p { margin: 0 0 0.25rem 0; font-size: 0.875rem; color: #4B5563; }
        .loading { text-align: center; padding: 2rem; color: #6B7280; }
        .marcacion-card { background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; }
        .marcacion-card.hoy { border-left: 4px solid #10B981; background: #F0FDF4; }
        .marcacion-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .marcacion-tipo { font-weight: 600; color: #1F2937; font-size: 1rem; }
        .marcacion-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: 600; }
        .badge-entrada { background: #DCFCE7; color: #166534; }
        .badge-salida { background: #FEE2E2; color: #991B1B; }
        .badge-colacion { background: #FED7AA; color: #9A3412; }
        .marcacion-info { font-size: 0.875rem; color: #6B7280; line-height: 1.5; }
        .empty-state { text-align: center; padding: 2rem; color: #9CA3AF; }
    </style>
</head>
<body>
    <div id="loadingScreen" class="container">
        <div class="loading"><h2>Cargando...</h2></div>
    </div>

    <!-- LOGIN -->
    <div id="loginView" class="container hidden">
        <h1>CVS Asistencia</h1>
        <p class="subtitle">Electric Mobility Services</p>
        <div class="tabs">
            <button class="tab active" id="tabEmpleado" onclick="selectTab('empleado')">üë∑ Empleado</button>
            <button class="tab" id="tabAdmin" onclick="selectTab('admin')">üëî Admin</button>
            <button class="tab" id="tabFiscal" onclick="selectTab('fiscalizador')">üõ°Ô∏è DT</button>
        </div>
        <form id="loginForm" onsubmit="login(event)">
            <label id="labelId">RUT</label>
            <input type="text" id="inputId" placeholder="12.345.678-9" required>
            <label>Contrase√±a</label>
            <input type="password" id="inputPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            <button type="submit" class="btn-login" id="btnLogin">Iniciar Sesi√≥n</button>
        </form>
        <div class="info">CVS ELECTRIC MOBILITY SERVICES SPA<br>RUT: 78.324.019-K<br><br>‚ÑπÔ∏è Contrase√±a: <strong>cvs2026</strong></div>
    </div>
    
    <!-- EMPLEADO -->
    <div id="employeeView" class="container hidden">
        <h1>CVS Asistencia</h1>
        <p class="subtitle">Control de Asistencia</p>
        <div class="employee-info" id="empInfo"></div>
        <label>üìç Seleccione Obra/Faena:</label>
        <select id="selectObra" required><option value="">Seleccione...</option></select>
        <button class="btn-marca" onclick="marcar('ENTRADA')">‚úì MARCAR ENTRADA</button>
        <button class="btn-marca" onclick="marcar('INICIO COLACI√ìN')">‚è∞ INICIO COLACI√ìN</button>
        <button class="btn-marca" onclick="marcar('FIN COLACI√ìN')">‚è∞ FIN COLACI√ìN</button>
        <button class="btn-marca" onclick="marcar('SALIDA')">‚úì MARCAR SALIDA</button>
        <button class="btn-historial" onclick="verHistorial()">üìã VER MI HISTORIAL</button>
        <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>
    
    <!-- HISTORIAL -->
    <div id="historialView" class="container hidden">
        <h1>Mi Historial</h1>
        <p class="subtitle">Registro de Asistencia</p>
        <div class="employee-info"><p style="font-weight: 600; color: #1F2937;" id="histNombre"></p></div>
        <div style="margin-bottom: 1rem;">
            <label>Filtrar por fecha:</label>
            <select id="filtroFecha" onchange="filtrarMarcaciones()" style="margin-bottom: 0;">
                <option value="todas">Todas las marcaciones</option>
                <option value="hoy">Solo hoy</option>
                <option value="semana">√öltima semana</option>
                <option value="mes">√öltimo mes</option>
            </select>
        </div>
        <div id="listaMarcaciones" style="margin-bottom: 1rem;"></div>
        <button class="btn-logout" onclick="volverDesdeHistorial()">‚Üê Volver</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7"></script>
    <script>
        const SUPABASE_URL = 'https://yhgiitkblzhpkjjrzmoz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InloZ2lpdGtibHpocGtqanJ6bW96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1OTk1MzIsImV4cCI6MjA4NTE3NTUzMn0.6did5rBQ0nLu2qMQ6S7wTwzMU8F-a6AtZj_EUnm3tO0';
        let supabase, tipoLogin = 'empleado', currentUser = null, todasMarcaciones = [];
        
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof window.supabase === 'undefined') { alert('Error cargando sistema'); return; }
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('‚úÖ Supabase conectado');
                    cargarObras();
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('loginView').classList.remove('hidden');
                } catch (error) { alert('Error: ' + error.message); }
            }, 500);
        });
        
        async function cargarObras() {
            try {
                const { data, error } = await supabase.from('obras_faenas').select('*').eq('activo', true);
                if (error) { console.error('Error obras:', error); return; }
                const select = document.getElementById('selectObra');
                if (data) data.forEach(obra => {
                    const opt = document.createElement('option');
                    opt.value = obra.id;
                    opt.textContent = obra.nombre;
                    opt.dataset.nombre = obra.nombre;
                    select.appendChild(opt);
                });
                console.log('‚úÖ Obras cargadas:', data.length);
            } catch (e) { console.error('Excepci√≥n obras:', e); }
        }
        
        function selectTab(tipo) {
            tipoLogin = tipo;
            document.getElementById('tabEmpleado').classList.remove('active');
            document.getElementById('tabAdmin').classList.remove('active');
            document.getElementById('tabFiscal').classList.remove('active');
            if (tipo === 'empleado') {
                document.getElementById('tabEmpleado').classList.add('active');
                document.getElementById('labelId').textContent = 'RUT';
                document.getElementById('inputId').placeholder = '12.345.678-9';
            } else if (tipo === 'admin') {
                document.getElementById('tabAdmin').classList.add('active');
                document.getElementById('labelId').textContent = 'Email';
                document.getElementById('inputId').placeholder = 'admin@cvs.cl';
            } else {
                document.getElementById('tabFiscal').classList.add('active');
                document.getElementById('labelId').textContent = 'Email';
                document.getElementById('inputId').placeholder = 'fiscalizador@dt.gob.cl';
            }
        }
        
        async function login(e) {
            e.preventDefault();
            let id = document.getElementById('inputId').value.trim();
            const pass = document.getElementById('inputPass').value;
            const btn = document.getElementById('btnLogin');
            
            if (tipoLogin === 'empleado') {
                let rutLimpio = id.replace(/\./g, '').replace(/-/g, '');
                if (rutLimpio.length >= 8) {
                    let cuerpo = rutLimpio.slice(0, -1);
                    let dv = rutLimpio.slice(-1);
                    cuerpo = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    id = cuerpo + '-' + dv;
                }
            }
            
            btn.disabled = true;
            btn.textContent = 'Ingresando...';
            
            try {
                console.log('Login:', id, 'tipo:', tipoLogin);
                if (tipoLogin === 'empleado') {
                    const { data, error } = await supabase.from('empleados').select('*').eq('rut', id).eq('activo', true).single();
                    console.log('Respuesta:', data, error);
                    if (error) { console.error('Error:', JSON.stringify(error)); alert('‚ùå RUT no encontrado'); return; }
                    if (!data) { alert('‚ùå RUT no encontrado'); return; }
                    if (pass !== 'cvs2026') { alert('‚ùå Contrase√±a incorrecta'); return; }
                    currentUser = data;
                    console.log('‚úÖ Login exitoso');
                    showEmployeeView();
                } else {
                    alert('Vista ' + tipoLogin + ' en desarrollo');
                }
            } catch (error) {
                console.error('Error login:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Iniciar Sesi√≥n';
            }
        }
        
        function showEmployeeView() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('employeeView').classList.remove('hidden');
            const info = document.getElementById('empInfo');
            info.innerHTML = `<p style="font-size: 0.75rem; color: #6B7280;">Empleado</p>
                <p style="font-weight: 600; color: #1F2937;">${currentUser.nombre_completo}</p>
                <p style="font-size: 0.875rem; color: #6B7280;">${currentUser.rut}</p>
                <p style="font-size: 0.75rem; color: #9CA3AF;">${currentUser.cargo}</p>`;
        }
        
        async function marcar(tipo) {
            const select = document.getElementById('selectObra');
            const obraId = select.value;
            if (!obraId) { alert('‚ö†Ô∏è Seleccione una obra/faena'); return; }
            const obraNombre = select.options[select.selectedIndex].dataset.nombre;
            if (!navigator.geolocation) { alert('‚ùå GPS no disponible'); return; }
            console.log('Obteniendo GPS...');
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    try {
                        console.log('GPS:', pos.coords.latitude, pos.coords.longitude);
                        const marcacion = {
                            id_empleado: currentUser.id, nombre_empleado: currentUser.nombre_completo,
                            email_empleado: currentUser.email_personal, rut_empleado: currentUser.rut,
                            tipo_evento: tipo, id_obra_faena: obraId, nombre_obra_faena: obraNombre,
                            latitud: pos.coords.latitude, longitud: pos.coords.longitude,
                            precision_gps: pos.coords.accuracy, id_dispositivo: 'DEV-' + Date.now(),
                            sincronizado: true, hash_verificacion: 'HASH-' + Date.now()
                        };
                        console.log('Guardando...');
                        const { error } = await supabase.from('marcaciones').insert([marcacion]);
                        if (error) { console.error('Error:', error); throw error; }
                        console.log('‚úÖ Guardado');
                        alert('‚úÖ Marcaci√≥n registrada: ' + tipo + '\nüìç ' + obraNombre + '\n\nüí° Puede ver su historial en "VER MI HISTORIAL"');
                    } catch (error) {
                        console.error('Error marcaci√≥n:', error);
                        alert('‚ùå Error: ' + error.message);
                    }
                },
                (error) => { console.error('Error GPS:', error); alert('‚ùå Active la ubicaci√≥n'); },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        async function verHistorial() {
            console.log('Cargando historial...');
            try {
                const { data, error } = await supabase.from('marcaciones').select('*').eq('rut_empleado', currentUser.rut).is('deleted_at', null).order('timestamp_real', { ascending: false }).limit(100);
                if (error) { console.error('Error historial:', error); alert('‚ùå Error'); return; }
                todasMarcaciones = data || [];
                console.log('‚úÖ Marcaciones:', todasMarcaciones.length);
                document.getElementById('employeeView').classList.add('hidden');
                document.getElementById('historialView').classList.remove('hidden');
                document.getElementById('histNombre').textContent = currentUser.nombre_completo;
                filtrarMarcaciones();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        function filtrarMarcaciones() {
            const filtro = document.getElementById('filtroFecha').value;
            const ahora = new Date();
            const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
            let marcacionesFiltradas = todasMarcaciones;
            if (filtro === 'hoy') {
                marcacionesFiltradas = todasMarcaciones.filter(m => new Date(m.timestamp_real) >= hoy);
            } else if (filtro === 'semana') {
                const semana = new Date(ahora.getTime() - 7 * 24 * 60 * 60 * 1000);
                marcacionesFiltradas = todasMarcaciones.filter(m => new Date(m.timestamp_real) >= semana);
            } else if (filtro === 'mes') {
                const mes = new Date(ahora.getTime() - 30 * 24 * 60 * 60 * 1000);
                marcacionesFiltradas = todasMarcaciones.filter(m => new Date(m.timestamp_real) >= mes);
            }
            mostrarMarcaciones(marcacionesFiltradas);
        }
        
        function mostrarMarcaciones(marcaciones) {
            const lista = document.getElementById('listaMarcaciones');
            if (!marcaciones || marcaciones.length === 0) {
                lista.innerHTML = '<div class="empty-state">üì≠ No hay marcaciones</div>';
                return;
            }
            const ahora = new Date();
            const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
            let html = '';
            marcaciones.forEach(m => {
                const fecha = new Date(m.timestamp_real);
                const esHoy = fecha >= hoy;
                const badgeClass = m.tipo_evento === 'ENTRADA' ? 'badge-entrada' : m.tipo_evento === 'SALIDA' ? 'badge-salida' : 'badge-colacion';
                html += `<div class="marcacion-card ${esHoy ? 'hoy' : ''}">
                    <div class="marcacion-header">
                        <div class="marcacion-tipo">${m.tipo_evento}</div>
                        <div class="marcacion-badge ${badgeClass}">${esHoy ? '‚úì HOY' : formatearFecha(fecha)}</div>
                    </div>
                    <div class="marcacion-info">
                        üïê ${fecha.toLocaleDateString('es-CL')} - ${fecha.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' })}<br>
                        üìç ${m.nombre_obra_faena || 'Obra no especificada'}<br>
                        ${m.sincronizado ? '‚úÖ Sincronizado' : '‚è≥ Pendiente'}
                    </div>
                </div>`;
            });
            lista.innerHTML = html;
        }
        
        function formatearFecha(fecha) {
            return fecha.toLocaleDateString('es-CL', { day: '2-digit', month: 'short' }).toUpperCase();
        }
        
        function volverDesdeHistorial() {
            document.getElementById('historialView').classList.add('hidden');
            document.getElementById('employeeView').classList.remove('hidden');
        }
        
        function logout() {
            currentUser = null;
            todasMarcaciones = [];
            document.getElementById('employeeView').classList.add('hidden');
            document.getElementById('historialView').classList.add('hidden');
            document.getElementById('loginView').classList.remove('hidden');
            document.getElementById('inputId').value = '';
            document.getElementById('inputPass').value = '';
            document.getElementById('selectObra').value = '';
        }
    </script>
</body>
</html>
