<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVS Asistencia - Sistema de Control</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Iconos SVG simples
        const ClockIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 6v6l4 2"/>
            </svg>
        );

        const CheckIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M20 6L9 17l-5-5"/>
            </svg>
        );

        const MapPinIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg>
        );

        // DATOS DE LA EMPRESA
        const EMPRESA = {
            razonSocial: 'CVS ELECTRIC MOBILITY SERVICES SPA',
            rut: '78.324.019-K',
            direccion: 'Santiago, Regi√≥n Metropolitana, Chile'
        };

        // COLORES CORPORATIVOS CVS
        const COLORES = {
            azul: '#3B82F6',
            rosa: '#EC4899',
            gris: '#4B5563'
        };

        // Hook para localStorage
        const useStorage = (key, initialValue) => {
            const [value, setValue] = useState(() => {
                try {
                    const stored = localStorage.getItem(key);
                    return stored ? JSON.parse(stored) : initialValue;
                } catch {
                    return initialValue;
                }
            });

            useEffect(() => {
                localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);

            return [value, setValue];
        };

        // Generar ID √∫nico del dispositivo
        const getDeviceId = () => {
            let deviceId = localStorage.getItem('cvs_device_id');
            if (!deviceId) {
                deviceId = `DEV-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
                localStorage.setItem('cvs_device_id', deviceId);
            }
            return deviceId;
        };

        // Generar hash de verificaci√≥n
        const generarHash = (data) => {
            const str = JSON.stringify(data);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return `SHA256-${Math.abs(hash).toString(16).toUpperCase().padStart(16, '0')}`;
        };

        // Geocodificaci√≥n reversa
        const geocodificarInversa = async (lat, lng) => {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18`,
                    { headers: { 'User-Agent': 'CVS-Asistencia-App' } }
                );
                const data = await response.json();
                return data?.display_name || `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch {
                return `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        };

        // Componente principal
        const CVSAsistenciaApp = () => {
            const [view, setView] = useState('empleado');
            const [currentUser] = useState({
                rut: '12.345.678-9',
                nombre: 'Mar√≠a Gonz√°lez L√≥pez',
                email: 'maria.gonzalez@personal.com',
                cargo: 'Operador de Carga'
            });

            const [marcaciones, setMarcaciones] = useStorage('cvs_marcaciones', []);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            const obtenerUbicacion = () => {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocalizaci√≥n no soportada'));
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                precision: position.coords.accuracy
                            });
                        },
                        (error) => {
                            let mensaje = 'Error obteniendo ubicaci√≥n';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    mensaje = 'Permiso de ubicaci√≥n denegado. Active el GPS.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    mensaje = 'Ubicaci√≥n no disponible.';
                                    break;
                                case error.TIMEOUT:
                                    mensaje = 'Tiempo agotado. Intente nuevamente.';
                                    break;
                            }
                            reject(new Error(mensaje));
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                });
            };

            const marcar = async (tipoEvento) => {
                try {
                    const loc = await obtenerUbicacion();

                    if (!loc || !loc.lat || !loc.lng) {
                        alert('‚ùå Error: No se pudo obtener la ubicaci√≥n GPS.');
                        return;
                    }

                    const direccion = await geocodificarInversa(loc.lat, loc.lng);
                    const timestampServidor = new Date().toISOString();
                    const dispositivoId = getDeviceId();

                    const nuevaMarcacion = {
                        id: `MARK-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
                        id_empleado: currentUser.rut,
                        nombre_empleado: currentUser.nombre,
                        email_empleado: currentUser.email,
                        tipo_evento: tipoEvento,
                        timestamp_real: timestampServidor,
                        fecha: new Date(timestampServidor).toLocaleDateString('es-CL'),
                        hora: new Date(timestampServidor).toLocaleTimeString('es-CL'),
                        latitud: loc.lat,
                        longitud: loc.lng,
                        precision_gps: loc.precision,
                        direccion_aproximada: direccion,
                        id_dispositivo: dispositivoId,
                        marca_dispositivo: navigator.userAgent.match(/\(([^)]+)\)/)?.[1] || 'Desconocido',
                        sincronizado: isOnline,
                        created_at: timestampServidor
                    };

                    nuevaMarcacion.hash_verificacion = generarHash({
                        id_empleado: nuevaMarcacion.id_empleado,
                        timestamp: nuevaMarcacion.timestamp_real,
                        lat: nuevaMarcacion.latitud,
                        lng: nuevaMarcacion.longitud,
                        tipo: nuevaMarcacion.tipo_evento
                    });

                    setMarcaciones(prev => [...prev, nuevaMarcacion]);

                    // Simular env√≠o de comprobante
                    console.log('üìß COMPROBANTE ENVIADO A:', currentUser.email);
                    console.log('Marcaci√≥n:', nuevaMarcacion);

                    alert(`‚úÖ Marcaci√≥n registrada: ${tipoEvento}\n\nüìß Comprobante enviado a:\n${currentUser.email}\n\nüïê ${nuevaMarcacion.hora}\nüìç ${direccion.substring(0, 60)}...`);

                } catch (error) {
                    alert(`‚ùå Error: ${error.message}`);
                    console.error('Error en marcaci√≥n:', error);
                }
            };

            const VistaEmpleado = () => {
                const marcacionesHoy = marcaciones.filter(m => m.fecha === new Date().toLocaleDateString('es-CL'));
                const ultimaMarca = marcaciones.length > 0 ? marcaciones[marcaciones.length - 1] : null;

                return (
                    <div style={{ 
                        minHeight: '100vh', 
                        background: 'linear-gradient(135deg, #3B82F6 0%, #EC4899 100%)',
                        padding: '1rem'
                    }}>
                        <div style={{ maxWidth: '28rem', margin: '0 auto' }}>
                            {/* Header */}
                            <div style={{ 
                                background: 'white', 
                                borderRadius: '1rem', 
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem'
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                    <div>
                                        <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: COLORES.gris, margin: 0 }}>
                                            CVS Asistencia
                                        </h1>
                                        <p style={{ fontSize: '0.75rem', color: '#6B7280', margin: '0.25rem 0 0 0' }}>
                                            Electric Mobility Services
                                        </p>
                                    </div>
                                    <div style={{ 
                                        background: 'linear-gradient(135deg, #3B82F6 0%, #EC4899 100%)',
                                        padding: '0.75rem',
                                        borderRadius: '50%',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}>
                                        <div style={{ color: 'white' }}><ClockIcon /></div>
                                    </div>
                                </div>

                                {/* Estado conexi√≥n */}
                                <div style={{
                                    background: isOnline ? '#F0FDF4' : '#FFF7ED',
                                    border: isOnline ? '1px solid #86EFAC' : '1px solid #FED7AA',
                                    borderRadius: '0.5rem',
                                    padding: '0.5rem 0.75rem',
                                    marginBottom: '0.75rem',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.5rem'
                                }}>
                                    <div style={{
                                        width: '0.5rem',
                                        height: '0.5rem',
                                        borderRadius: '50%',
                                        background: isOnline ? '#22C55E' : '#F97316'
                                    }}></div>
                                    <p style={{
                                        fontSize: '0.75rem',
                                        fontWeight: '500',
                                        color: isOnline ? '#15803D' : '#C2410C',
                                        margin: 0
                                    }}>
                                        {isOnline ? '‚úÖ En l√≠nea' : '‚ö†Ô∏è Modo offline'}
                                    </p>
                                </div>

                                <div style={{
                                    background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%)',
                                    borderRadius: '0.5rem',
                                    padding: '1rem'
                                }}>
                                    <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: '0 0 0.25rem 0' }}>Empleado</p>
                                    <p style={{ fontWeight: '600', color: '#1F2937', margin: '0 0 0.25rem 0' }}>{currentUser.nombre}</p>
                                    <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: '0 0 0.25rem 0' }}>{currentUser.rut}</p>
                                    <p style={{ fontSize: '0.75rem', color: '#9CA3AF', margin: 0 }}>{currentUser.cargo}</p>
                                </div>
                            </div>

                            {/* Reloj */}
                            <div style={{
                                background: 'white',
                                borderRadius: '1rem',
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem',
                                textAlign: 'center'
                            }}>
                                <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: '0 0 0.5rem 0' }}>Hora actual</p>
                                <div style={{
                                    background: 'linear-gradient(135deg, #3B82F6 0%, #EC4899 100%)',
                                    WebkitBackgroundClip: 'text',
                                    WebkitTextFillColor: 'transparent',
                                    fontSize: '2.5rem',
                                    fontWeight: 'bold',
                                    marginBottom: '0.5rem'
                                }}>
                                    {currentTime.toLocaleTimeString('es-CL', { 
                                        hour: '2-digit', 
                                        minute: '2-digit',
                                        second: '2-digit'
                                    })}
                                </div>
                                <p style={{ fontSize: '0.875rem', color: '#6B7280', margin: 0 }}>
                                    {currentTime.toLocaleDateString('es-CL', { 
                                        weekday: 'long',
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    })}
                                </p>
                            </div>

                            {/* √öltima marcaci√≥n */}
                            {ultimaMarca && (
                                <div style={{
                                    background: '#F0FDF4',
                                    border: '2px solid #86EFAC',
                                    borderRadius: '1rem',
                                    padding: '1rem',
                                    marginBottom: '1.5rem'
                                }}>
                                    <div style={{ display: 'flex', gap: '0.75rem' }}>
                                        <div style={{ color: '#16A34A', marginTop: '0.25rem' }}>
                                            <CheckIcon />
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <p style={{ fontWeight: '600', color: '#166534', margin: '0 0 0.25rem 0' }}>
                                                √öltima marcaci√≥n
                                            </p>
                                            <p style={{ fontSize: '0.875rem', color: '#15803D', margin: '0 0 0.25rem 0' }}>
                                                {ultimaMarca.tipo_evento}
                                            </p>
                                            <p style={{ fontSize: '0.75rem', color: '#16A34A', margin: 0 }}>
                                                {ultimaMarca.fecha} - {ultimaMarca.hora}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Botones de marcaje */}
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem', marginBottom: '1.5rem' }}>
                                <button
                                    onClick={() => marcar('ENTRADA')}
                                    style={{
                                        width: '100%',
                                        background: 'linear-gradient(135deg, #10B981 0%, #059669 100%)',
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '1rem 1.5rem',
                                        borderRadius: '0.75rem',
                                        border: 'none',
                                        boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                        cursor: 'pointer',
                                        fontSize: '1rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '0.5rem'
                                    }}
                                >
                                    <CheckIcon />
                                    MARCAR ENTRADA
                                </button>

                                <button
                                    onClick={() => marcar('INICIO COLACI√ìN')}
                                    style={{
                                        width: '100%',
                                        background: 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)',
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '1rem 1.5rem',
                                        borderRadius: '0.75rem',
                                        border: 'none',
                                        boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                        cursor: 'pointer',
                                        fontSize: '1rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '0.5rem'
                                    }}
                                >
                                    <ClockIcon />
                                    INICIO COLACI√ìN
                                </button>

                                <button
                                    onClick={() => marcar('FIN COLACI√ìN')}
                                    style={{
                                        width: '100%',
                                        background: 'linear-gradient(135deg, #3B82F6 0%, #EC4899 100%)',
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '1rem 1.5rem',
                                        borderRadius: '0.75rem',
                                        border: 'none',
                                        boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                        cursor: 'pointer',
                                        fontSize: '1rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '0.5rem'
                                    }}
                                >
                                    <ClockIcon />
                                    FIN COLACI√ìN
                                </button>

                                <button
                                    onClick={() => marcar('SALIDA')}
                                    style={{
                                        width: '100%',
                                        background: 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)',
                                        color: 'white',
                                        fontWeight: '600',
                                        padding: '1rem 1.5rem',
                                        borderRadius: '0.75rem',
                                        border: 'none',
                                        boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                        cursor: 'pointer',
                                        fontSize: '1rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        gap: '0.5rem'
                                    }}
                                >
                                    <CheckIcon />
                                    MARCAR SALIDA
                                </button>
                            </div>

                            {/* Marcaciones del d√≠a */}
                            <div style={{
                                background: 'white',
                                borderRadius: '1rem',
                                boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                padding: '1.5rem',
                                marginBottom: '1.5rem'
                            }}>
                                <h3 style={{ fontWeight: '600', color: '#1F2937', marginBottom: '1rem' }}>
                                    Marcaciones de hoy
                                </h3>

                                {marcacionesHoy.length === 0 ? (
                                    <p style={{ textAlign: 'center', color: '#6B7280', padding: '1rem 0' }}>
                                        No hay marcaciones registradas hoy
                                    </p>
                                ) : (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                        {marcacionesHoy.map(m => (
                                            <div key={m.id} style={{
                                                border: '1px solid #E5E7EB',
                                                borderRadius: '0.5rem',
                                                padding: '0.75rem'
                                            }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                                    <div>
                                                        <p style={{ fontWeight: '600', color: '#1F2937', margin: 0 }}>
                                                            {m.tipo_evento}
                                                        </p>
                                                        <p style={{ fontSize: '0.875rem', fontFamily: 'monospace', color: '#6B7280', margin: '0.25rem 0 0 0' }}>
                                                            {m.hora}
                                                        </p>
                                                    </div>
                                                    <span style={{
                                                        fontSize: '0.75rem',
                                                        fontWeight: 'bold',
                                                        padding: '0.25rem 0.5rem',
                                                        borderRadius: '0.25rem',
                                                        background: m.sincronizado ? '#DCFCE7' : '#FEF3C7',
                                                        color: m.sincronizado ? '#166534' : '#92400E'
                                                    }}>
                                                        {m.sincronizado ? '‚úì Sync' : '‚è≥ Pend'}
                                                    </span>
                                                </div>
                                                <div style={{ display: 'flex', alignItems: 'start', gap: '0.25rem', fontSize: '0.75rem', color: '#6B7280' }}>
                                                    <MapPinIcon />
                                                    <span style={{ lineHeight: '1.2' }}>
                                                        {m.direccion_aproximada?.substring(0, 100) || `${m.latitud?.toFixed(6)}, ${m.longitud?.toFixed(6)}`}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Info legal */}
                            <div style={{
                                background: 'rgba(255, 255, 255, 0.95)',
                                border: '1px solid rgba(59, 130, 246, 0.3)',
                                borderRadius: '0.75rem',
                                padding: '1rem'
                            }}>
                                <p style={{ fontSize: '0.75rem', fontWeight: '600', color: COLORES.azul, margin: '0 0 0.5rem 0' }}>
                                    Sistema certificado Dictamen 1140/27
                                </p>
                                <p style={{ fontSize: '0.75rem', color: '#4B5563', margin: 0 }}>
                                    {EMPRESA.razonSocial} - RUT {EMPRESA.rut}<br />
                                    Todos los registros tienen validez legal como medio de prueba en juicios laborales.
                                </p>
                            </div>
                        </div>
                    </div>
                );
            };

            return <VistaEmpleado />;
        };

        // Renderizar la aplicaci√≥n
        ReactDOM.render(<CVSAsistenciaApp />, document.getElementById('root'));
    </script>
</body>
</html>
